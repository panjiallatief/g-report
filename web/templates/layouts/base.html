<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }} - IT Broadcast Ops</title>

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/906/906309.png">

    <!-- Tailwind CSS (Gunakan CDN standard untuk development agar lebih stabil) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>

    <!-- AlpineJS - DITAMBAHKAN "defer" UNTUK MEMPERBAIKI ERROR -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        .slide-up {
            animation: slideUp 0.4s ease-out;
        }

        .hover-scale {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-scale:hover {
            transform: scale(1.02);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-gray-100 text-slate-800">
    {{ template "content" . }}

    <!-- Notification Permission Banner (Hanya muncul jika belum subscribe) -->
    <div id="push-permission-banner"
        class="hidden fixed bottom-0 left-0 w-full bg-blue-600 text-white p-4 z-[9999] shadow-[0_-5px_20px_rgba(0,0,0,0.3)] slide-up pb-8 md:pb-4">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-full shrink-0">
                    <i class="fas fa-bell text-xl"></i>
                </div>
                <div class="text-sm">
                    <p class="font-bold">Nyalakan Notifikasi?</p>
                    <p class="text-blue-100 text-xs">Dapatkan alert tiket urgent secara realtime.</p>
                </div>
            </div>
            <div class="flex gap-2 shrink-0">
                <button onclick="window.NotifSystem.dismissBanner()"
                    class="px-3 py-2 text-xs text-blue-200 hover:text-white font-medium">Nanti</button>
                <button id="btn-activate-push" onclick="window.NotifSystem.subscribe()"
                    class="px-4 py-2 bg-white text-blue-600 rounded-lg text-xs font-bold shadow-lg hover:bg-blue-50 transition transform active:scale-95 flex items-center justify-center min-w-[80px]">
                    Aktifkan
                </button>
            </div>
        </div>
    </div>

    <div id="https-warning"
        class="hidden fixed top-0 left-0 w-full bg-red-500 text-white p-2 z-[9999] text-center text-xs font-bold">
        ⚠️ Fitur Notifikasi memerlukan HTTPS.
    </div>

    <script>
        // Global Notification System
        window.NotifSystem = {
            urlBase64ToUint8Array: function (base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
                return outputArray;
            },

            getRegistration: async function () {
                if (!('serviceWorker' in navigator)) return null;
                let reg = await navigator.serviceWorker.getRegistration('/');
                if (!reg) {
                    try { reg = await navigator.serviceWorker.register('/sw.js'); }
                    catch (err) { console.error('[SW] Fail:', err); return null; }
                }
                return reg;
            },

            subscribe: async function (btnId = 'btn-activate-push') {
                const btn = document.getElementById(btnId);
                const originalText = btn ? btn.innerHTML : '';
                if (btn) { btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true; }

                try {
                    const reg = await this.getRegistration();
                    if (!reg) throw new Error("Service Worker Error");

                    const resKey = await fetch('/notifications/vapid-public-key');
                    if (!resKey.ok) throw new Error("Key Error");
                    const data = await resKey.json();

                    const sub = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: this.urlBase64ToUint8Array(data.publicKey)
                    });

                    const resSub = await fetch('/notifications/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sub)
                    });

                    if (!resSub.ok) throw new Error("Backend Save Failed");

                    // Success
                    localStorage.setItem('push_subscribed_success', 'true');
                    document.getElementById('push-permission-banner').classList.add('hidden');

                    // Dispatch Event agar halaman Profile bisa update UI
                    window.dispatchEvent(new CustomEvent('push-subscription-changed', { detail: { active: true } }));

                    alert("Notifikasi Aktif!");

                } catch (err) {
                    console.error(err);
                    alert("Gagal: " + err.message);
                } finally {
                    if (btn) { btn.innerHTML = originalText; btn.disabled = false; }
                }
            },

            unsubscribe: async function (btnId = '') {
                if (!confirm("Matikan notifikasi di perangkat ini?")) return;

                const btn = btnId ? document.getElementById(btnId) : null;
                const original = btn ? btn.innerHTML : '';
                if (btn) { btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true; }

                try {
                    const reg = await this.getRegistration();
                    const sub = await reg.pushManager.getSubscription();
                    if (sub) {
                        // Delete from Backend
                        await fetch('/notifications/unsubscribe', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ endpoint: sub.endpoint })
                        });

                        // Unsubscribe from Browser
                        await sub.unsubscribe();
                    }

                    localStorage.removeItem('push_subscribed_success');
                    window.dispatchEvent(new CustomEvent('push-subscription-changed', { detail: { active: false } }));
                    alert("Notifikasi dimatikan.");

                } catch (e) {
                    console.error(e);
                    alert("Gagal mematikan notifikasi.");
                } finally {
                    if (btn) { btn.innerHTML = original; btn.disabled = false; }
                }
            },

            test: async function (btnId) {
                const btn = document.getElementById(btnId);
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;

                try {
                    const res = await fetch('/notifications/test', { method: 'POST' });
                    if (!res.ok) throw new Error("Failed");
                } catch (e) {
                    alert("Gagal test.");
                } finally {
                    btn.innerHTML = original;
                    btn.disabled = false;
                }
            },

            dismissBanner: function () {
                document.getElementById('push-permission-banner').classList.add('hidden');
                localStorage.setItem('push_banner_dismissed', 'true');
            },

            checkStatus: async function () {
                const reg = await this.getRegistration();
                if (!reg) return false;
                const sub = await reg.pushManager.getSubscription();
                return !!sub;
            }
        };

        // On Load Logic
        window.addEventListener('load', async () => {
            if (!window.isSecureContext && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.getElementById('https-warning').classList.remove('hidden');
            }

            const isActive = await window.NotifSystem.checkStatus();

            // Trigger event untuk inisialisasi state di Profile page
            window.dispatchEvent(new CustomEvent('push-subscription-changed', { detail: { active: isActive } }));

            // Logic Banner (Hanya muncul jika BELUM aktif dan BELUM di-dismiss)
            if (!isActive) {
                const isDismissed = localStorage.getItem('push_banner_dismissed') === 'true';
                if (!isDismissed && Notification.permission !== 'denied') {
                    document.getElementById('push-permission-banner').classList.remove('hidden');
                }
            } else {
                document.getElementById('push-permission-banner').classList.add('hidden');
            }
        });
    </script>
</body>

</html>