<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }} - IT Broadcast Ops</title>

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/906/906309.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>
    <!-- AlpineJS -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .slide-up { animation: slideUp 0.4s ease-out; }
        .hover-scale { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-scale:hover { transform: scale(1.02); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>

<body class="bg-gray-100 text-slate-800">
    {{ template "content" . }}

    <!-- Notification Permission Banner -->
    <div id="push-permission-banner"
        class="hidden fixed bottom-0 left-0 w-full bg-blue-600 text-white p-4 z-[9999] shadow-[0_-5px_20px_rgba(0,0,0,0.3)] slide-up pb-8 md:pb-4">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-full shrink-0">
                    <i class="fas fa-bell text-xl"></i>
                </div>
                <div class="text-sm">
                    <p class="font-bold">Nyalakan Notifikasi?</p>
                    <p class="text-blue-100 text-xs">Dapatkan alert tiket urgent secara realtime.</p>
                </div>
            </div>
            <div class="flex gap-2 shrink-0">
                <button onclick="dismissPushBanner()"
                    class="px-3 py-2 text-xs text-blue-200 hover:text-white font-medium">Nanti</button>
                <button id="btn-activate-push" onclick="requestPushPermission()"
                    class="px-4 py-2 bg-white text-blue-600 rounded-lg text-xs font-bold shadow-lg hover:bg-blue-50 transition transform active:scale-95 flex items-center justify-center min-w-[80px]">
                    Aktifkan
                </button>
            </div>
        </div>
    </div>

    <div id="https-warning" class="hidden fixed top-0 left-0 w-full bg-red-500 text-white p-2 z-[9999] text-center text-xs font-bold">
        ⚠️ Fitur Notifikasi memerlukan HTTPS (Ngrok) atau Localhost.
    </div>

    <script>
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function getOrRegisterSW() {
            if (!('serviceWorker' in navigator)) return null;
            let reg = await navigator.serviceWorker.getRegistration('/');
            if (!reg) {
                try {
                    reg = await navigator.serviceWorker.register('/sw.js');
                    console.log('[SW] New registration successful:', reg.scope);
                } catch (err) {
                    console.error('[SW] Registration failed:', err);
                    return null;
                }
            }
            return reg;
        }

        async function requestPushPermission() {
            const btn = document.getElementById('btn-activate-push');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const registration = await getOrRegisterSW();
                if (!registration) throw new Error("Service Worker gagal dimuat.");

                console.log('[Push] Fetching VAPID Key...');
                const response = await fetch('/notifications/vapid-public-key', {
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                
                if (!response.ok) throw new Error("Gagal mengambil kunci server");
                const data = await response.json();
                const applicationServerKey = urlBase64ToUint8Array(data.publicKey);

                // Unsubscribe Old
                const existingSub = await registration.pushManager.getSubscription();
                if (existingSub) {
                    console.log('[Push] Removing old sub...');
                    await existingSub.unsubscribe();
                }

                console.log('[Push] Subscribing new...');
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });

                console.log('[Push] Sending to backend...');
                const resSub = await fetch('/notifications/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify(subscription)
                });

                if (!resSub.ok) throw new Error("Backend save failed: " + resSub.status);

                localStorage.setItem('push_subscribed_success', 'true');
                document.getElementById('push-permission-banner').classList.add('hidden');
                
                // [TEST] Coba kirim notifikasi test lokal
                registration.showNotification('Notifikasi Aktif!', {
                    body: 'Sistem notifikasi telah berhasil diaktifkan.',
                    icon: 'https://cdn-icons-png.flaticon.com/512/906/906309.png'
                });

                alert('Sukses! Anda akan menerima notifikasi tiket urgent.');

            } catch (err) {
                console.error('[Push] Error Detail:', err);
                alert('Gagal: ' + err.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function dismissPushBanner() {
            document.getElementById('push-permission-banner').classList.add('hidden');
            localStorage.setItem('push_banner_dismissed', 'true');
        }

        window.addEventListener('load', async () => {
            if (!window.isSecureContext && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.getElementById('https-warning').classList.remove('hidden');
                return;
            }

            // Cleanup old SW
            navigator.serviceWorker.getRegistration('/static/sw.js').then(reg => {
                if (reg) reg.unregister().then(() => window.location.reload());
            });

            const reg = await getOrRegisterSW();
            if (reg) {
                const sub = await reg.pushManager.getSubscription();
                const isDismissed = localStorage.getItem('push_banner_dismissed') === 'true';
                const isManualSuccess = localStorage.getItem('push_subscribed_success') === 'true';
                
                // Debug Reset via URL ?reset_push=true
                if (new URLSearchParams(window.location.search).get('reset_push') === 'true') {
                    if (sub) await sub.unsubscribe();
                    localStorage.removeItem('push_banner_dismissed');
                    localStorage.removeItem('push_subscribed_success');
                    await reg.unregister();
                    alert('Reset Complete. Reloading...');
                    window.location.href = window.location.pathname;
                    return;
                }

                if (!sub && Notification.permission !== 'denied' && !isDismissed && !isManualSuccess) {
                    document.getElementById('push-permission-banner').classList.remove('hidden');
                }
            }
        });
    </script>
</body>
</html>