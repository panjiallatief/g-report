<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }} - IT Broadcast Ops</title>

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/906/906309.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>
    <!-- AlpineJS -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        .slide-up {
            animation: slideUp 0.4s ease-out;
        }

        .hover-scale {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-scale:hover {
            transform: scale(1.02);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-gray-100 text-slate-800">
    {{ template "content" . }}

    <!-- Notification Permission Banner (Optional UI) -->
    <div id="push-permission-banner"
        class="hidden fixed bottom-0 left-0 w-full bg-blue-600 text-white p-4 z-50 shadow-lg slide-up">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-bell text-2xl"></i>
                <div class="text-sm">
                    <p class="font-bold">Aktifkan Notifikasi?</p>
                    <p class="text-blue-100 text-xs">Dapatkan alert tiket urgent secara realtime.</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="dismissPushBanner()"
                    class="px-3 py-1.5 text-xs text-blue-200 hover:text-white">Nanti</button>
                <button onclick="requestPushPermission()"
                    class="px-4 py-1.5 bg-white text-blue-600 rounded-lg text-xs font-bold shadow hover:bg-blue-50">Aktifkan</button>
            </div>
        </div>
    </div>

    <script>
        // --- Service Worker & Push Logic ---

        // Helper: Convert VAPID Key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/static/sw.js');
                    console.log('SW Registered:', registration.scope);
                    return registration;
                } catch (err) {
                    console.error('SW Registration failed:', err);
                }
            }
            return null;
        }

        async function requestPushPermission() {
            dismissPushBanner(); // Hide UI

            const registration = await navigator.serviceWorker.ready;
            if (!registration) return;

            try {
                // 1. Get VAPID Public Key from Backend
                const response = await fetch('/notifications/vapid-public-key');
                const data = await response.json();
                const applicationServerKey = urlBase64ToUint8Array(data.publicKey);

                // 2. Subscribe via PushManager
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });

                console.log('User Subscribed:', subscription);

                // 3. Send Subscription to Backend
                await fetch('/notifications/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(subscription)
                });

                alert('Notifikasi diaktifkan!');

            } catch (err) {
                console.error('Failed to subscribe:', err);
                alert('Gagal mengaktifkan notifikasi: ' + err.message);
            }
        }

        function dismissPushBanner() {
            document.getElementById('push-permission-banner').classList.add('hidden');
            localStorage.setItem('push_banner_dismissed', 'true');
        }

        // Init
        window.addEventListener('load', async () => {
            const reg = await registerServiceWorker();

            // Check if user is already subscribed or dismissed
            if (reg && 'pushManager' in reg) {
                const sub = await reg.pushManager.getSubscription();

                // [FIX] Jika subscription ada tapi VAPID key berubah di backend (Invalid State), kita perlu unsubscribe dulu
                if (sub) {
                    try {
                        // Optional: Verify key match or just assume valid if exists. 
                        // But since we just changed keys, let's force resubscribe if needed? 
                        // For now, let's just log it.
                        console.log('Existing subscription:', sub);
                    } catch (e) {
                        console.error('Subscription check failed', e);
                    }
                }

                if (!sub && localStorage.getItem('push_banner_dismissed') !== 'true') {
                    // Show banner if not subscribed
                    document.getElementById('push-permission-banner').classList.remove('hidden');
                }
            }
        });

        // Debug Helper: Reset Permission State
        window.resetPushState = async () => {
            localStorage.removeItem('push_banner_dismissed');
            const reg = await navigator.serviceWorker.ready;
            const sub = await reg.pushManager.getSubscription();
            if (sub) await sub.unsubscribe();
            alert('Push state reset. Please reload.');
            location.reload();
        }
    </script>
</body>

</html>