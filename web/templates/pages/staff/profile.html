{{ define "content" }}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />

<div class="max-w-[480px] mx-auto min-h-screen bg-white flex flex-col relative fade-in" x-data="{ 
        notifActive: false,
        async check() {
            this.notifActive = await window.NotifSystem.checkStatus();
        }
     }" x-init="check(); window.addEventListener('push-subscription-changed', (e) => notifActive = e.detail.active)">

    <!-- Header -->
    <div class="bg-white p-4 flex items-center gap-4 border-b border-slate-100">
        <a href="/staff" class="text-slate-400 hover:text-slate-800"><i class="fas fa-arrow-left text-xl"></i></a>
        <h1 class="text-xl font-bold text-slate-800">Profil Saya</h1>
    </div>

    <!-- Edit Profile Form -->
    <form id="profileForm" class="p-6 flex flex-col items-center w-full">
        <!-- Avatar -->
        <div class="relative mb-6 group cursor-pointer hover-scale"
            onclick="document.getElementById('avatarInput').click()">
            <img src="{{ if .user.AvatarURL }}{{ .user.AvatarURL }}?t={{ .now }}{{ else }}https://ui-avatars.com/api/?name={{ .user.FullName }}&background=0f172a&color=fff&size=200{{ end }}"
                class="w-32 h-32 rounded-full shadow-xl border-4 border-white ring-2 ring-slate-100 object-cover group-hover:brightness-90 transition"
                id="avatarPreview">
            <div
                class="absolute bottom-0 right-0 w-10 h-10 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center group-hover:bg-blue-700 transition border-2 border-white">
                <i class="fas fa-camera"></i>
            </div>
            <input type="file" name="avatar" id="avatarInput" class="hidden" accept="image/*">
        </div>

        <!-- Name Input -->
        <input type="text" name="fullname" id="fullnameInput" value="{{ .user.FullName }}"
            class="text-2xl font-bold text-slate-800 text-center bg-transparent border-b-2 border-transparent focus:border-blue-500 focus:outline-none transition mb-1 w-full"
            placeholder="Nama Lengkap">

        <p class="text-slate-500 text-sm font-medium mb-6">{{ .user.Role }} &bull; {{ .user.Email }}</p>

        <!-- Save Button -->
        <button type="button" id="saveBtn"
            class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold text-sm hover:bg-blue-700 shadow-md transition mb-8 flex items-center gap-2 hover-scale">
            <i class="fas fa-save"></i> Simpan Profil
        </button>
    </form>

    <div class="px-6 pb-24 w-full space-y-6">

        <!-- PENGATURAN NOTIFIKASI (BARU) -->
        <div>
            <h3 class="font-bold text-slate-800 mb-3 text-sm uppercase tracking-wide">Notifikasi</h3>
            <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center"
                            :class="notifActive ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400'">
                            <i class="fas" :class="notifActive ? 'fa-bell' : 'fa-bell-slash'"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-700 text-sm">Push Notification</p>
                            <p class="text-xs" :class="notifActive ? 'text-green-600 font-bold' : 'text-slate-400'">
                                <span x-text="notifActive ? 'Aktif di perangkat ini' : 'Tidak Aktif'"></span>
                            </p>
                        </div>
                    </div>

                    <!-- Tombol Toggle (Aktifkan) jika Mati -->
                    <button x-show="!notifActive" @click="window.NotifSystem.subscribe('btn-profile-sub')"
                        id="btn-profile-sub"
                        class="bg-blue-600 text-white text-xs font-bold px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm">
                        Aktifkan
                    </button>
                </div>

                <!-- Kontrol jika Aktif (Test & Matikan) -->
                <div x-show="notifActive" class="grid grid-cols-2 gap-3 border-t border-slate-100 pt-3" x-transition>
                    <button @click="window.NotifSystem.test('btn-profile-test')" id="btn-profile-test"
                        class="flex items-center justify-center gap-2 bg-slate-50 text-slate-700 border border-slate-200 py-2 rounded-lg text-xs font-bold hover:bg-slate-100 transition">
                        <i class="fas fa-paper-plane"></i> Test Kirim
                    </button>
                    <button @click="window.NotifSystem.unsubscribe('btn-profile-unsub')" id="btn-profile-unsub"
                        class="flex items-center justify-center gap-2 bg-red-50 text-red-600 border border-red-100 py-2 rounded-lg text-xs font-bold hover:bg-red-100 transition">
                        <i class="fas fa-ban"></i> Matikan
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div>
            <h3 class="font-bold text-slate-800 mb-3 text-sm uppercase tracking-wide">Akun</h3>
            <div class="space-y-3">
                <button
                    class="w-full bg-white border border-slate-200 p-4 rounded-xl flex items-center justify-between hover:bg-slate-50 transition group">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition">
                            <i class="fas fa-lock"></i>
                        </div>
                        <span class="font-bold text-slate-700">Ganti Password</span>
                    </div>
                    <i class="fas fa-chevron-right text-slate-300"></i>
                </button>
                <a href="/auth/logout"
                    class="w-full bg-red-50 border border-red-100 p-4 rounded-xl flex items-center justify-between hover:bg-red-100 transition group">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-10 h-10 rounded-full bg-white text-red-500 flex items-center justify-center shadow-sm">
                            <i class="fas fa-sign-out-alt"></i>
                        </div>
                        <span class="font-bold text-red-600">Logout</span>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAV (IT STAFF) -->
    <nav
        class="fixed bottom-0 w-full max-w-[480px] bg-white border-t border-slate-200 flex justify-around py-3 px-2 text-[10px] font-bold text-slate-400 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] backdrop-blur-md bg-white/95">
        <a href="/staff" class="flex flex-col items-center gap-1.5 hover:text-blue-600 w-16 transition">
            <i class="fas fa-home text-lg"></i> Home
        </a>
        <a href="/staff/alerts" class="flex flex-col items-center gap-1.5 hover:text-blue-600 w-16 transition relative">
            <i class="fas fa-bell text-lg"></i> Alert
            {{ if .urgentCount }}
            {{ if gt .urgentCount 0 }}
            <span
                class="absolute top-0 right-3 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
            {{ end }}
            {{ end }}
        </a>
        <a href="/staff/history" class="flex flex-col items-center gap-1.5 hover:text-blue-600 w-16 transition">
            <i class="fas fa-history text-lg"></i> History
        </a>
        <a href="/staff/profile" class="flex flex-col items-center gap-1.5 text-blue-600 w-16 transition">
            <i class="fas fa-user text-lg"></i> Profile
        </a>
    </nav>
</div>

<!-- Image Cropper Modal (Tetap sama) -->
<div id="cropperModal" class="hidden fixed inset-0 z-[60] bg-black/90 flex flex-col">
    <div class="flex justify-between items-center p-4 text-white">
        <h3 class="font-bold">Sesuaikan Foto</h3>
        <button onclick="closeCropper()" class="text-white hover:text-red-400"><i
                class="fas fa-times text-xl"></i></button>
    </div>
    <div class="flex-1 overflow-hidden bg-black flex items-center justify-center relative">
        <img id="imageToCrop" src="" class="max-w-full max-h-full block">
    </div>
    <div class="p-4 bg-black flex justify-between items-center gap-4">
        <button onclick="closeCropper()" class="px-6 py-2 text-white font-bold text-sm">Batal</button>
        <button onclick="cropAndSave()"
            class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold text-sm hover:bg-blue-700">Pilih
            Foto</button>
    </div>
</div>

<!-- Scripts Cropper (Tetap sama) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script>
    let cropper;
    const avatarInput = document.getElementById('avatarInput');
    const imageToCrop = document.getElementById('imageToCrop');
    const modal = document.getElementById('cropperModal');
    let croppedBlob = null;

    avatarInput.addEventListener('change', function (e) {
        if (e.target.files && e.target.files.length > 0) {
            const file = e.target.files[0];
            if (file.size > 2 * 1024 * 1024) {
                alert("Ukuran foto terlalu besar! Maksimal 2MB.");
                this.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function (evt) {
                imageToCrop.src = evt.target.result;
                modal.classList.remove('hidden');
                if (cropper) cropper.destroy();
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 0.8,
                });
            };
            reader.readAsDataURL(file);
        }
    });

    function closeCropper() {
        modal.classList.add('hidden');
        avatarInput.value = '';
        if (cropper) cropper.destroy();
    }

    function cropAndSave() {
        if (!cropper) return;
        cropper.getCroppedCanvas({
            width: 400,
            height: 400
        }).toBlob((blob) => {
            croppedBlob = blob;
            const url = URL.createObjectURL(blob);
            document.getElementById('avatarPreview').src = url;
            closeCropper();
        }, 'image/jpeg', 0.8);
    }

    document.getElementById('saveBtn').addEventListener('click', function () {
        const formData = new FormData();
        formData.append('fullname', document.getElementById('fullnameInput').value);
        if (croppedBlob) {
            formData.append('avatar', croppedBlob, 'avatar.jpg');
        } else if (avatarInput.files[0]) {
            formData.append('avatar', avatarInput.files[0]);
        }

        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
        btn.disabled = true;

        fetch('/staff/profile/update', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert("Gagal menyimpan profil.");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("Terjadi kesalahan.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    });
</script>
{{ end }}