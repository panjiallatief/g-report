services:
  app:
    image: panjiallatief/goreport:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: goreport_app
    restart: always
    ports:
      - "${PORT:-8086}:8080"
    environment:
      # Database - Use host.docker.internal to connect to host machine's database
      - DB_HOST=${DB_HOST:-host.docker.internal}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - DB_PORT=${DB_PORT:-5432}
      # Redis - Using containerized Redis
      - REDIS_URL=redis:6379
      # Application
      - PORT=8080
      - SERVER_IP=${SERVER_IP:-}
      - DISABLE_HTTPS=${DISABLE_HTTPS:-false}
      - SESSION_SECRET=${SESSION_SECRET}
      # LDAP (Optional)
      - LDAP_URL=${LDAP_URL:-}
      - LDAP_DOMAIN=${LDAP_DOMAIN:-}
      - LDAP_BASE_DN=${LDAP_BASE_DN:-}
      # Push Notifications (Optional)
      - VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY:-}
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY:-}
    volumes:
      - ./web/uploads:/app/web/uploads
      - ./cert:/app/cert
      - ./certs:/app/certs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - redis
    networks:
      - goreport_network

  redis:
    image: redis:7-alpine
    container_name: goreport_redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - goreport_network

networks:
  goreport_network:
    driver: bridge

volumes:
  redis_data:
